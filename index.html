<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Rifa Manuel</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #faf8f5; color: #222; text-align: center; }

    h2 { font-family: 'Arial Black', Gadget, sans-serif; font-size: 34px; color: #b30000; text-shadow: 2px 2px 6px #ccc; margin-bottom: 6px; }

    ol.lista-rifa {
      background: #fff0e6;
      padding: 12px 20px;
      border-radius: 10px;
      width: fit-content;
      margin: 8px auto 18px auto;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.12);
      font-weight: bold;
      color: #333;
      list-style-position: inside;
    }
    ol.lista-rifa li { margin-bottom: 6px; }

    .hero-img { display: block; margin: 10px auto 12px auto; width: 18%; height: auto; border-radius: 12px; box-shadow: 3px 3px 18px rgba(0,0,0,0.18); transition: transform 0.3s, box-shadow 0.3s; }
    .hero-img:hover { transform: scale(1.05); box-shadow: 6px 6px 30px rgba(0,0,0,0.28); }

    .sorteo-principal {
      font-weight: bold;
      color: #b30000;
      font-size: 18px;
      background: #fff4f0;
      padding: 10px 15px;
      border-radius: 10px;
      display: inline-block;
      box-shadow: 2px 2px 12px rgba(0,0,0,0.12);
      margin-bottom: 12px;
    }

    .sorteo-info {
      margin: 10px auto 20px auto;
      max-width: 600px;
      background: #fff3e6;
      border-radius: 12px;
      padding: 12px 20px;
      color: #b30000;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 2px 2px 12px rgba(0,0,0,0.12);
    }

    .tabla-wrap {
      width: fit-content;
      margin: 18px auto;
      padding: 10px;
      border-radius: 10px;
      border: 3px solid #b30000;
      background: linear-gradient(180deg,#fffdf7,#fffaf3);
      box-shadow: 3px 3px 18px rgba(0,0,0,0.12);
    }

    table { border-collapse: collapse; position: relative; }
    td {
      border: 1px solid #bfbfbf;
      width: 60px;
      height: 60px;
      padding: 4px;
      position: relative;
      vertical-align: top;
      background: #fffdf7;
      transition: background 0.2s, transform 0.08s;
      border-radius: 6px;
    }
    td:active { transform: translateY(1px); }

    .numero { position: absolute; top: 4px; left: 4px; font-weight: 700; font-size: 13px; color: #b30000; text-shadow: 1px 1px 0 #fff; z-index: 3; }
    .editable { position: absolute; bottom: 4px; left: 4px; right: 4px; font-size: 13px; padding: 2px 4px; min-height: 18px; border-radius: 4px; outline: none; cursor: text; color: #222; word-wrap: break-word; z-index: 1; }
    .editable[contenteditable="false"] { cursor: default; }
    .editable:hover { background: #f6f6f6; }

    input[type="checkbox"] { position: absolute; top: 4px; right: 4px; width: 18px; height: 18px; border-radius: 50%; z-index: 2; cursor: pointer; }

    .ocupado { background-color: #d4f8d4 !important; border: 1px solid #5cb85c !important; box-shadow: inset 0 0 6px rgba(0,100,0,0.12); font-weight: 700; }
    .premiado { background-color: gold !important; border: 2px solid #b30000 !important; box-shadow: 0 0 6px rgba(0,0,0,0.5); }

    .pw-box {
      text-align: center;
      margin-top: 20px;
      background: #fff0e6;
      padding: 15px 25px;
      border-radius: 12px;
      border: 2px solid #ffcc80;
      display: inline-block;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }
    .pw-box input[type="password"] { padding: 8px 12px; border-radius: 12px; border: 1px solid #b30000; width: 180px; font-size: 16px; text-align: center; }
    .pw-box button { padding: 8px 14px; margin-left: 8px; background: #b30000; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .pw-box button:hover { opacity: 0.9; transform: scale(1.05); }

    @media (max-width: 720px) {
      .hero-img { width: 28%; }
      td { width: 44px; height: 44px; }
      .editable { font-size: 12px; }
    }
  </style>
</head>
<body>

<h2>Rifa Cesta Navidad</h2>

<ol class="lista-rifa">
  <li>Jam√≥n</li>
  <li>Paleta</li>
  <li>D√©cimo Loter√≠a Nacional</li>
</ol>

<p class="sorteo-principal">
  üìÖ <strong>Sorteo: 21 de diciembre de 2025</strong><br>
  üçÄ La terminaci√≥n del n√∫mero premiado de la ONCE decidir√° la casilla ganadora üçÄ
</p>

<img class="hero-img" src="imagenes/renderedimage.jpeg" alt="Premio">

<div class="sorteo-info">
  ‚ö†Ô∏è Atenci√≥n: El d√≠a del sorteo aparecer√° una caja para comprobar el ganador, debes ingresar la terminaci√≥n del n√∫mero que ha salido en el sorteo del 21 de diciembre de 2025. El sistema marcar√° autom√°ticamente la casilla ganadora en la tabla.
</div>

<div class="tabla-wrap">
  <table id="tablaRifa" aria-label="Tabla rifa"></table>
</div>

<div class="pw-box">
  <label for="pwd">Contrase√±a para modificar nombres/pagado:</label><br><br>
  <input type="password" id="pwd" placeholder="Introduce la contrase√±a">
  <button id="btnPwd">Aceptar</button>
  <button id="btnLogout" style="display:none; margin-left:8px;">Cerrar</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNg_YSCyPJd0MJUTHYTTeQCHRckkCWVrU",
  authDomain: "rifa-manuel.firebaseapp.com",
  databaseURL: "https://rifa-manuel-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "rifa-manuel",
  storageBucket: "rifa-manuel.firebasedata.app",
  messagingSenderId: "431157221434",
  appId: "1:431157221434:web:235a69a675bdaf220ebd03"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tabla = document.getElementById("tablaRifa");
const btnPwd = document.getElementById("btnPwd");
const inputPwd = document.getElementById("pwd");
const btnLogout = document.getElementById("btnLogout");
const CORRECT_PWD = "1919";
let canEdit = sessionStorage.getItem('rifa_can_edit') === '1';

function setEditState(state) {
  canEdit = !!state;
  if (canEdit) { 
    sessionStorage.setItem('rifa_can_edit', '1'); 
    btnLogout.style.display = "inline-block"; 
  } else { 
    sessionStorage.removeItem('rifa_can_edit'); 
    btnLogout.style.display = "none"; 
  }
}

btnPwd.addEventListener("click", () => {
  if(inputPwd.value === CORRECT_PWD) { 
    setEditState(true); 
    alert("Contrase√±a correcta."); 
  } else { 
    alert("Contrase√±a incorrecta."); 
  }
  inputPwd.value = "";
});

btnLogout.addEventListener("click", () => { 
  setEditState(false); 
  alert("Modo edici√≥n cerrado."); 
});

let numero = 1;
function construirTabla() {
  tabla.innerHTML = "";
  numero = 1;
  for(let fila=0; fila<10; fila++) {
    const tr = document.createElement("tr");
    for(let col=0; col<10; col++) {
      const td = document.createElement("td");
      const thisNumero = numero;

      const numeroSpan = document.createElement("span");
      numeroSpan.className = "numero";
      numeroSpan.innerText = thisNumero===100?"00":thisNumero;

      const editableSpan = document.createElement("div");
      editableSpan.className="editable";
      editableSpan.id="n"+thisNumero;
      editableSpan.contentEditable=false;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";

      // --- CLICK SOBRE NOMBRE ---
      editableSpan.addEventListener("click", ()=>{
        if(editableSpan.innerText.trim() !== "" && !canEdit){
          alert("Esta celda ya tiene nombre. Introduce la contrase√±a para modificarlo.");
          return;
        }

        if(editableSpan.innerText.trim() === ""){
          const nombre = prompt("Introduce tu nombre:");
          if(!nombre || nombre.trim() === "") return;

          // Modal de pago
          const modal = document.createElement("div");
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100%";
          modal.style.height = "100%";
          modal.style.background = "rgba(0,0,0,0.7)";
          modal.style.display = "flex";
          modal.style.justifyContent = "center";
          modal.style.alignItems = "center";
          modal.style.zIndex = "1000";

          const contenido = document.createElement("div");
          contenido.style.background = "linear-gradient(135deg, #ffefba, #ffffff)";
          contenido.style.padding = "25px";
          contenido.style.borderRadius = "20px";
          contenido.style.textAlign = "center";
          contenido.style.maxWidth = "320px";
          contenido.style.boxShadow = "0 8px 25px rgba(0,0,0,0.25)";
          contenido.style.border = "2px solid #ff9900";

          contenido.innerHTML = `
            <p style="font-weight:bold; color:#b30000;">Para reservar este n√∫mero debes pagar <strong>3‚ÄØ‚Ç¨</strong>.</p>
            <button id="btnRevolut" style="margin:5px;padding:10px 15px;border:none;border-radius:12px;background:#0070BA;color:white;cursor:pointer;font-weight:bold;">
              Pagar por Revolut
            </button>
            <button id="btnEfectivo" style="margin:5px;padding:10px 15px;border:none;border-radius:12px;background:#28a745;color:white;cursor:pointer;font-weight:bold;">
              Pagar en efectivo
            </button>
            <br><br>
            <button id="confirmPago" style="display:none;padding:10px 15px;border:none;border-radius:12px;background:#ff6600;color:white;cursor:pointer;font-weight:bold;">
              Confirmar que he pagado
            </button>
            <button id="btnCancelar" style="margin:5px;padding:10px 15px;border:none;border-radius:12px;background:#ccc;color:#222;cursor:pointer;font-weight:bold;">
              Cancelar
            </button>
          `;

          modal.appendChild(contenido);
          document.body.appendChild(modal);

          // --- ANIMACI√ìN DE LUCES ---
          const canvas = document.createElement("canvas");
          canvas.style.position = "fixed";
          canvas.style.top = "0";
          canvas.style.left = "0";
          canvas.style.width = "100%";
          canvas.style.height = "100%";
          canvas.style.pointerEvents = "none";
          canvas.style.zIndex = "999";
          modal.appendChild(canvas);

          const ctx = canvas.getContext("2d");
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;

          const luces = [];
          for(let i=0;i<50;i++){
            luces.push({
              x: Math.random()*canvas.width,
              y: Math.random()*canvas.height,
              r: Math.random()*3+1.5,
              dx: (Math.random()-0.5)*1.5,
              dy: (Math.random()-0.5)*1.5,
              color: ["#ff0000","#00ff00","#ffff00","#ff6600","#ff00ff"][Math.floor(Math.random()*5)]
            });
          }

          function animarLuces(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            luces.forEach(l=>{
              ctx.beginPath();
              ctx.arc(l.x,l.y,l.r,0,Math.PI*2);
              ctx.fillStyle = l.color;
              ctx.fill();
              l.x += l.dx;
              l.y += l.dy;
              if(l.x<0) l.x=canvas.width;
              if(l.x>canvas.width) l.x=0;
              if(l.y<0) l.y=canvas.height;
              if(l.y>canvas.height) l.y=0;
            });
            requestAnimationFrame(animarLuces);
          }
          animarLuces();
          window.addEventListener("resize", ()=>{
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          });

          let pagoOk = false;
          document.getElementById("btnRevolut").addEventListener("click", () => {
            window.open("https://revolut.me/manuelb14p", "_blank");
            pagoOk = true;
            document.getElementById("confirmPago").style.display = "inline-block";
          });

          document.getElementById("btnEfectivo").addEventListener("click", () => {
            alert("Debes entregar los 3‚ÄØ‚Ç¨ en efectivo al organizador para confirmar tu reserva.");
            pagoOk = true;
            document.getElementById("confirmPago").style.display = "inline-block";
          });

          document.getElementById("confirmPago").addEventListener("click", () => {
            if (!pagoOk) return;
            const keyNombre = "nombres/" + thisNumero;
            const keyPagado = "pagado/" + thisNumero;
            db.ref(keyNombre).set(nombre.trim());
            db.ref(keyPagado).set(true);

            checkbox.checked = true;
            editableSpan.classList.add("ocupado");
            editableSpan.contentEditable = false;
            document.body.removeChild(modal);
            alert("¬°N√∫mero reservado correctamente!");
          });

          document.getElementById("btnCancelar").addEventListener("click", () => {
            document.body.removeChild(modal);
          });

          return;
        }

        if(canEdit){
          editableSpan.contentEditable = true;
          editableSpan.focus();
        }
      });

      editableSpan.addEventListener("blur", ()=>{
        const texto = editableSpan.innerText.trim();
        const key = "nombres/"+thisNumero;
        if(texto !== ""){
          if(canEdit || !editableSpan.classList.contains("ocupado")){
            db.ref(key).set(texto);
            editableSpan.classList.add("ocupado");
          } else {
            db.ref(key).once("value").then(snap=>{ editableSpan.innerText = snap.val() || ""; });
          }
        } else {
          if(canEdit) { db.ref(key).remove(); editableSpan.classList.remove("ocupado"); }
          else { db.ref(key).once("value").then(snap=>{ editableSpan.innerText = snap.val() || ""; }); }
        }
        editableSpan.contentEditable=false;
      });

      // --- CHECKBOX ---
      checkbox.addEventListener("change", ()=>{
        if(canEdit){ 
          db.ref("pagado/"+thisNumero).set(checkbox.checked ? true : null);
        } else {
          checkbox.checked = !checkbox.checked;
          alert("Debes introducir la contrase√±a para modificar el estado de pago.");
        }
      });

      td.appendChild(numeroSpan);
      td.appendChild(editableSpan);
      td.appendChild(checkbox);
      tr.appendChild(td);
      numero++;
    }
    tabla.appendChild(tr);
  }
}

construirTabla();

// --- SYNC FIREBASE ---
const nombresRef = db.ref("nombres");
nombresRef.on("child_added", snap=>updateCell(parseInt(snap.key,10), snap.val()));
nombresRef.on("child_changed", snap=>updateCell(parseInt(snap.key,10), snap.val()));
nombresRef.on("child_removed", snap=>updateCell(parseInt(snap.key,10), ""));

const pagadoRef = db.ref("pagado");
pagadoRef.on("child_added", snap=>updateCheckbox(parseInt(snap.key,10), snap.val()));
pagadoRef.on("child_changed", snap=>updateCheckbox(parseInt(snap.key,10), snap.val()));
pagadoRef.on("child_removed", snap=>updateCheckbox(parseInt(snap.key,10), false));

nombresRef.once("value").then(snapshot=>{
  const data = snapshot.val()||{};
  for(const k in data) updateCell(parseInt(k,10), data[k]);
});
pagadoRef.once("value").then(snapshot=>{
  const data = snapshot.val()||{};
  for(const k in data) updateCheckbox(parseInt(k,10), data[k]);
});

function updateCell(num,text){
  const el = document.getElementById("n"+num);
  if(!el) return;
  el.innerText = text||"";
  if(text && text.trim()!=="") { el.classList.add("ocupado"); el.contentEditable=false; }
  else { el.classList.remove("ocupado"); el.contentEditable=false; }
}

function updateCheckbox(num, val){
  const td = document.getElementById("n"+num)?.parentNode;
  if(!td) return;
  const cb = td.querySelector("input[type='checkbox']");
  if(!cb) return;
  cb.checked = !!val;
}

function marcarPremiado() {
  const hoy = new Date();
  if(hoy.getDate() === 21 && hoy.getMonth() === 11) {
    const terminacion = prompt("Introduce la terminaci√≥n del n√∫mero premiado (2 d√≠gitos):");
    for(let i=1; i<=100; i++){
      const lastTwo = i===100?"00":String(i).padStart(2,"0");
      if(lastTwo === terminacion){
        const td = document.getElementById("n"+i).parentNode;
        if(td) td.classList.add("premiado");
        break;
      }
    }
  }
}

window.addEventListener("load", marcarPremiado);

if(canEdit) btnLogout.style.display="inline-block";
</script>



</body>
</html>
