<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Rifa Manuel</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #faf8f5; color: #222; text-align: center; }

    h2 {
      font-family: 'Arial Black', Gadget, sans-serif;
      font-size: 34px;
      color: #b30000;
      text-shadow: 2px 2px 6px #ccc;
      margin-bottom: 6px;
    }

    ol {
      background: #fff0e6;
      padding: 12px 20px;
      border-radius: 10px;
      width: fit-content;
      margin: 8px auto 18px auto;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.12);
      font-weight: bold;
      color: #333;
    }
    ol li { margin-bottom: 6px; }

    .hero-img {
      display: block;
      margin: 10px auto 18px auto;
      width: 18%;
      height: auto;
      border-radius: 12px;
      box-shadow: 3px 3px 18px rgba(0,0,0,0.18);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .hero-img:hover { transform: scale(1.05); box-shadow: 6px 6px 30px rgba(0,0,0,0.28); }

    /* CONTRASE칌A ESTILIZADA */
    .pw-box {
      text-align: center;
      margin-bottom: 20px;
      background: #fff0e6;
      padding: 15px 25px;
      border-radius: 12px;
      border: 2px solid #ffcc80;
      display: inline-block;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }
    .pw-box input[type="password"] {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #b30000;
      width: 180px;
      font-size: 16px;
      text-align: center;
    }
    .pw-box button {
      padding: 8px 14px;
      margin-left: 8px;
      background: #b30000;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    .pw-box button:hover { opacity: 0.9; transform: scale(1.05); }

    .tabla-wrap {
      width: fit-content;
      margin: 18px auto;
      padding: 10px;
      border-radius: 10px;
      border: 3px solid #b30000;
      background: linear-gradient(180deg,#fffdf7,#fffaf3);
      box-shadow: 3px 3px 18px rgba(0,0,0,0.12);
    }

    table { border-collapse: collapse; position: relative; }
    td {
      border: 1px solid #bfbfbf;
      width: 60px;
      height: 60px;
      padding: 4px;
      position: relative;
      vertical-align: top;
      background: #fffdf7;
      transition: background 0.2s, transform 0.08s;
      border-radius: 6px;
    }
    td:active { transform: translateY(1px); }

    .numero {
      position: absolute;
      top: 4px;
      left: 4px;
      font-weight: 700;
      font-size: 13px;
      color: #b30000;
      text-shadow: 1px 1px 0 #fff;
      z-index: 3;
    }

    .editable {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      font-size: 13px;
      padding: 2px 4px;
      min-height: 18px;
      border-radius: 4px;
      outline: none;
      cursor: text;
      color: #222;
      word-wrap: break-word;
      z-index: 1;
    }
    .editable[contenteditable="false"] { cursor: default; }
    .editable:hover { background: #f6f6f6; }

    input[type="checkbox"] {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      z-index: 2;
      cursor: pointer;
    }

    .ocupado {
      background-color: #d4f8d4 !important;
      border: 1px solid #5cb85c !important;
      box-shadow: inset 0 0 6px rgba(0,100,0,0.12);
      font-weight: 700;
    }

    .premiado {
      background-color: gold !important;
      border: 2px solid #b30000 !important;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
    }

    @media (max-width: 720px) {
      .hero-img { width: 28%; }
      td { width: 44px; height: 44px; }
      .editable { font-size: 12px; }
    }
  </style>
</head>
<body>

<h2>Rifa Cesta Navidad</h2>

<ol>
  <li>Jam칩n</li>
  <li>Paleta</li>
  <li>D칠cimo Loter칤a Nacional</li>
</ol>

<p style="font-weight:bold; color:#b30000;">
游늰 Sorteo el d칤a <strong>21 de diciembre</strong> con la terminaci칩n del n칰mero premiado de la ONCE
</p>

<img class="hero-img" src="imagenes/renderedimage.jpeg" alt="Premio">

<div class="pw-box">
  <label for="pwd">Contrase침a para modificar nombres/pagado:</label>
  <input type="password" id="pwd" placeholder="Introduce la contrase침a">
  <button id="btnPwd">Aceptar</button>
  <button id="btnLogout" style="display:none; margin-left:8px;">Cerrar</button>
</div>

<div class="tabla-wrap">
  <table id="tablaRifa" aria-label="Tabla rifa"></table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNg_YSCyPJd0MJUTHYTTeQCHRckkCWVrU",
  authDomain: "rifa-manuel.firebaseapp.com",
  databaseURL: "https://rifa-manuel-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "rifa-manuel",
  storageBucket: "rifa-manuel.firebasestorage.app",
  messagingSenderId: "431157221434",
  appId: "1:431157221434:web:235a69a675bdaf220ebd03"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tabla = document.getElementById("tablaRifa");
const btnPwd = document.getElementById("btnPwd");
const inputPwd = document.getElementById("pwd");
const btnLogout = document.getElementById("btnLogout");
const CORRECT_PWD = "1919";
let canEdit = sessionStorage.getItem('rifa_can_edit') === '1';

function setEditState(state) {
  canEdit = !!state;
  if (canEdit) { sessionStorage.setItem('rifa_can_edit', '1'); btnLogout.style.display = "inline-block"; }
  else { sessionStorage.removeItem('rifa_can_edit'); btnLogout.style.display = "none"; }
}

btnPwd.addEventListener("click", () => {
  if(inputPwd.value === CORRECT_PWD) { setEditState(true); alert("Contrase침a correcta."); }
  else { alert("Contrase침a incorrecta."); }
  inputPwd.value = "";
});

btnLogout.addEventListener("click", () => { setEditState(false); alert("Modo edici칩n cerrado."); });

// Construcci칩n de tabla
let numero = 1;
function construirTabla() {
  tabla.innerHTML = "";
  numero = 1;
  for(let fila=0; fila<10; fila++) {
    const tr = document.createElement("tr");
    for(let col=0; col<10; col++) {
      const td = document.createElement("td");
      const thisNumero = numero;

      const numeroSpan = document.createElement("span");
      numeroSpan.className = "numero";
      numeroSpan.innerText = thisNumero===100?"00":thisNumero;

      const editableSpan = document.createElement("div");
      editableSpan.className="editable";
      editableSpan.id="n"+thisNumero;
      editableSpan.contentEditable=false;

      editableSpan.addEventListener("click", ()=>{
        if(!canEdit){ alert("Introduce la contrase침a para modificar nombres."); return; }
        editableSpan.contentEditable=true; editableSpan.focus();
      });

      editableSpan.addEventListener("blur", ()=>{
        if(!canEdit){ editableSpan.contentEditable=false; return; }
        const texto = editableSpan.innerText.trim();
        const key = "nombres/"+thisNumero;
        if(texto!==""){ db.ref(key).set(texto); editableSpan.classList.add("ocupado"); editableSpan.contentEditable=false; }
        else { db.ref(key).remove(); editableSpan.classList.remove("ocupado"); editableSpan.contentEditable=false; }
      });

      const checkbox = document.createElement("input");
      checkbox.type="checkbox";
      checkbox.disabled = !canEdit;
      checkbox.addEventListener("change", ()=>{
        if(!canEdit){ checkbox.checked = !checkbox.checked; return; }
        db.ref("pagado/"+thisNumero).set(checkbox.checked ? true : null);
      });

      td.appendChild(numeroSpan);
      td.appendChild(editableSpan);
      td.appendChild(checkbox);
      tr.appendChild(td);
      numero++;
    }
    tabla.appendChild(tr);
  }
}

construirTabla();

// Firebase listeners
const nombresRef = db.ref("nombres");
nombresRef.on("child_added", snap=>updateCell(parseInt(snap.key,10), snap.val()));
nombresRef.on("child_changed", snap=>updateCell(parseInt(snap.key,10), snap.val()));
nombresRef.on("child_removed", snap=>updateCell(parseInt(snap.key,10), ""));

const pagadoRef = db.ref("pagado");
pagadoRef.on("child_added", snap=>updateCheckbox(parseInt(snap.key,10), snap.val()));
pagadoRef.on("child_changed", snap=>updateCheckbox(parseInt(snap.key,10), snap.val()));
pagadoRef.on("child_removed", snap=>updateCheckbox(parseInt(snap.key,10), false));

nombresRef.once("value").then(snapshot=>{
  const data = snapshot.val()||{};
  for(const k in data) updateCell(parseInt(k,10), data[k]);
});
pagadoRef.once("value").then(snapshot=>{
  const data = snapshot.val()||{};
  for(const k in data) updateCheckbox(parseInt(k,10), data[k]);
});

function updateCell(num,text){
  const el = document.getElementById("n"+num);
  if(!el) return;
  el.innerText = text||"";
  if(text && text.trim()!=="") { el.classList.add("ocupado"); el.contentEditable=false; }
  else { el.classList.remove("ocupado"); el.contentEditable=false; }
}

function updateCheckbox(num, val){
  const td = document.getElementById("n"+num)?.parentNode;
  if(!td) return;
  const cb = td.querySelector("input[type='checkbox']");
  if(!cb) return;
  cb.checked = !!val;
  cb.disabled = !canEdit;
}

// ==== MARCAR CASILLA PREMIADA EL D칈A DEL SORTEO ====
function marcarPremiado() {
  const hoy = new Date();
  const diaSorteo = new Date(hoy.getFullYear(), 11, 21); // 21 diciembre (mes 11 = diciembre)
  if(hoy.getDate() === 21 && hoy.getMonth() === 11) {
    const terminacion = prompt("Introduce la terminaci칩n del n칰mero premiado (2 d칤gitos):");
    for(let i=1; i<=100; i++){
      const lastTwo = i===100?"00":String(i).padStart(2,"0");
      if(lastTwo === terminacion){
        const td = document.getElementById("n"+i).parentNode;
        if(td) td.classList.add("premiado");
        break;
      }
    }
  }
}

window.addEventListener("load", marcarPremiado);

if(canEdit) btnLogout.style.display="inline-block";
</script>

</body>
</html>

